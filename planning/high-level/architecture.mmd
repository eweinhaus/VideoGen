graph TB
    %% User Layer
    User[üë§ User]
    
    %% Frontend Layer
    subgraph Frontend["üåê Frontend (Next.js 14 + TypeScript)"]
        UI[Upload UI]
        CharacterUploader[Character Uploader]
        AnalysisReview[Character Review & Edit]
        Progress[Progress Tracker]
        Player[Video Player]
        SSE_Client[SSE Client]
        ClipSelector[Clip Selector<br/>Thumbnails + Lyrics]
        ClipChatbot[Clip Chatbot<br/>Conversational UI]
    end
    
    %% API Gateway Layer
    subgraph API_Gateway["‚öôÔ∏è API Gateway (FastAPI)"]
        REST[REST Endpoints]
        SSE_Server[SSE Stream Handler]
        Queue_Manager[BullMQ Queue Manager]
        Orchestrator[Pipeline Orchestrator]
        Budget_Guard[Budget Guard<br/>$20 limit]
        Rate_Limit[Rate Limiter<br/>5 jobs/hour]
        Content_Guard[Content Guard<br/>NSFW/CSAM]
        Feature_Flags[Feature Flags<br/>Per-user/Cohort/Global]
        Experiment_Assignor[Experiment Assignor<br/>A/B]
    end
    
    %% Queue System
    subgraph Queue["üìã Job Queue (BullMQ + Redis)"]
        Job_Queue[Job Queue]
        Worker1[Worker 1]
        Worker2[Worker 2]
        Analysis_Queue[Analysis Queue]
        WorkerA[Analysis Worker]
    end
    
    %% Processing Pipeline Modules
    subgraph Pipeline["üîÑ Processing Pipeline"]
        CharacterAnalyzer["[2] Character Analyzer<br/>Vision (GPT-4V)<br/>Normalization + Cache"]
        Module3["[3] Audio Parser<br/>Librosa + Aubio<br/>OpenAI Whisper"]
        Module4["[4] Scene Planner<br/>GPT-4o / Claude 3.5"]
        Module5["[5] Reference Generator<br/>SDXL via Replicate"]
        Module6["[6] Prompt Generator<br/>LLM Optimization"]
        Module7["[7] Video Generator<br/>Stable Video Diffusion<br/>(Parallel: 5 concurrent)<br/>1024x576 ‚Üí 1080p<br/>+ LoRA Application<br/>+ Thumbnail Generation"]
        Module8["[8] Composer<br/>FFmpeg<br/>Upscale + Transitions"]
        LoRA_Trainer["[LoRA] LoRA Trainer<br/>RunPod Integration<br/>Async Training<br/>30-60 min"]
        ClipRegenerator["[Clip] Clip Regenerator<br/>Template Matching<br/>LLM Prompt Modifier<br/>Single Clip Regeneration"]
    end
    
    %% External Services
    subgraph External["‚òÅÔ∏è External Services"]
        Supabase_Auth[Supabase Auth]
        Supabase_DB[(Supabase PostgreSQL)]
        Supabase_Storage[Supabase Storage<br/>audio-uploads<br/>reference-images<br/>video-clips<br/>video-outputs<br/>clip-thumbnails<br/>lora-models<br/>lora-validation-images]
        OpenAI[OpenAI API<br/>Whisper + GPT-4o]
        Replicate[Replicate API<br/>SDXL + SVD]
        RunPod[RunPod API<br/>GPU Instances<br/>LoRA Training]
    end
    
    %% User Flow
    User -->|Upload Audio + Prompt| UI
    User -->|Upload Character Image| CharacterUploader
    UI -->|POST /upload-audio| REST
    CharacterUploader -->|Upload Image| Supabase_Storage
    CharacterUploader -->|POST /upload/character/analyze| REST
    REST -->|Create Job| Rate_Limit
    Rate_Limit -->|Check Limit| Queue_Manager
    Queue_Manager -->|Budget Check| Budget_Guard
    Budget_Guard -->|Enqueue| Job_Queue
    REST -->|Content Check| Content_Guard
    Content_Guard -->|Enqueue Analysis| Queue_Manager
    Queue_Manager -->|Enqueue| Analysis_Queue
    
    %% Queue Processing
    Job_Queue -->|Process| Worker1
    Job_Queue -->|Process| Worker2
    Analysis_Queue -->|Process| WorkerA
    Worker1 -->|Execute| Orchestrator
    Worker2 -->|Execute| Orchestrator
    WorkerA -->|Execute| CharacterAnalyzer
    
    %% Pipeline Flow
    Orchestrator -->|Step 1: 10%| Module3
    Module3 -->|audio_data| Module4
    Orchestrator -->|Step 2: 20%| Module4
    Module4 -->|plan| Module5
    Orchestrator -->|Step 3: 30%| Module5
    Module5 -->|reference_images| Module6
    Module5 -.->|character_images| LoRA_Trainer
    LoRA_Trainer -.->|async training| RunPod
    Orchestrator -->|Step 4: 40%| Module6
    Module6 -->|clip_prompts| Module7
    Orchestrator -->|Step 5: 85%| Module7
    Module7 -->|LoRA check| Supabase_DB
    Supabase_DB -->|LoRA URL| Module7
    Module7 -->|clips| Module8
    Orchestrator -->|Step 6: 100%| Module8
    Module8 -->|final_video| Supabase_Storage
    
    %% Character Analysis Flow
    CharacterAnalyzer -->|Vision Inference| OpenAI
    CharacterAnalyzer -->|Store Analysis| Supabase_DB
    REST -->|GET /upload/character/analyze/{job_id}| AnalysisReview
    AnalysisReview -->|Confirm & Continue<br/>POST /generate| REST
    Feature_Flags -->|Evaluate| Orchestrator
    REST -->|character_analysis (optional)| Orchestrator
    Orchestrator -->|Character Features (if enabled)| Module4
    
    %% External Service Connections
    Module3 -->|Audio Analysis| Supabase_Storage
    Module3 -->|Lyrics Extraction| OpenAI
    Module4 -->|Scene Planning| OpenAI
    Module5 -->|Image Generation| Replicate
    Module6 -->|Prompt Optimization| OpenAI
    Module7 -->|Video Generation| Replicate
    Module7 -->|Reference Images| Supabase_Storage
    Module7 -->|LoRA-enhanced Images| Replicate
    LoRA_Trainer -->|Training| RunPod
    LoRA_Trainer -->|Store LoRA| Supabase_Storage
    LoRA_Trainer -->|Validation Images| Replicate
    
    %% Data Storage
    REST -->|Store Job| Supabase_DB
    Orchestrator -->|Update Status| Supabase_DB
    Module3 -->|Cache Analysis| Supabase_DB
    Module3 -->|Store Results| Supabase_DB
    REST -->|Store Plan Flags/Assignment| Supabase_DB
    UI -->|Upload Character Image| Supabase_Storage
    Supabase_DB -->|Character Analysis| Module4
    Module4 -->|Store Plan| Supabase_DB
    Module5 -->|Store Images| Supabase_Storage
    Module7 -->|Store Clips| Supabase_Storage
    Module7 -->|Generate Thumbnails| Supabase_Storage
    LoRA_Trainer -->|Store LoRA Metadata| Supabase_DB
    LoRA_Trainer -->|Store LoRA Files| Supabase_Storage
    LoRA_Trainer -->|Store Validation Images| Supabase_Storage
    
    %% Clip Regeneration Flow
    ClipSelector -->|Select Clip| ClipChatbot
    ClipChatbot -->|POST /clips/{idx}/regenerate| REST
    REST -->|Load Clip Data| Supabase_DB
    Supabase_DB -->|Clips/Prompts/Plan| ClipRegenerator
    ClipRegenerator -->|Template Check| ClipRegenerator
    ClipRegenerator -->|LLM Prompt Mod| OpenAI
    ClipRegenerator -->|Regenerate Clip| Module7
    Module7 -->|New Clip| Supabase_Storage
    ClipRegenerator -->|Recompose| Module8
    Module8 -->|Updated Video| Supabase_Storage
    ClipRegenerator -->|Store Regeneration| Supabase_DB
    
    %% Authentication
    UI -->|Login| Supabase_Auth
    REST -->|Validate Token| Supabase_Auth
    
    %% Real-time Updates
    Orchestrator -->|Progress Events| SSE_Server
    SSE_Server -->|SSE Stream| SSE_Client
    SSE_Client -->|Update UI| Progress
    Progress -->|Display| User
    
    %% Final Output
    Supabase_Storage -->|Video URL| REST
    REST -->|GET /download| Player
    Player -->|Play/Download| User
    
    %% Styling
    classDef frontend fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef api fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef pipeline fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef external fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef queue fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    
    class UI,CharacterUploader,AnalysisReview,Progress,Player,SSE_Client,ClipSelector,ClipChatbot frontend
    class REST,SSE_Server,Queue_Manager,Orchestrator,Budget_Guard,Rate_Limit,Content_Guard,Feature_Flags,Experiment_Assignor api
    class CharacterAnalyzer,Module3,Module4,Module5,Module6,Module7,Module8,LoRA_Trainer,ClipRegenerator pipeline
    class Supabase_Auth,Supabase_DB,Supabase_Storage,OpenAI,Replicate,RunPod external
    class Job_Queue,Worker1,Worker2,Analysis_Queue,WorkerA queue

