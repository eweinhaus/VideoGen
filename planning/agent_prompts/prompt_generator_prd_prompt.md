# Prompt Generator PRD Creation Prompt

## Instructions for AI Agent

You are tasked with creating a comprehensive Product Requirements Document (PRD) for **Module 6: Prompt Generator** in the AI Music Video Generation Pipeline. This module sits in the critical path between the Reference Generator (Module 5) and Video Generator (Module 7), and is responsible for synthesizing optimized video generation prompts that combine clip scripts, visual style, and reference images into concise, high-quality prompts suitable for text-to-video models.

**First, thoroughly analyze the existing codebase and documentation to understand the system architecture and requirements.** Review the memory bank files in `myles-docs/memory-bank/` (especially `activeContext.md`, `systemPatterns.md`, `progress.md`, and `techContext.md`) to understand the current implementation state, patterns, and technical decisions. Examine the existing PRD files in `planning/individual_PRDs/` (particularly `PRD_scene_planner.md` as a template for structure and detail level) and the high-level PRD in `planning/high-level/PRD.md` (sections on Module 6) to understand the module's purpose, inputs, outputs, and success criteria. Study the Pydantic models in `project/backend/shared/models/scene.py` (ScenePlan, ReferenceImages) and `project/backend/shared/models/video.py` (ClipPrompts, ClipPrompt) to understand the exact data contracts, field requirements, and validation rules. Review the orchestrator in `project/backend/api_gateway/orchestrator.py` to see how this module will be called and integrated, and check `project/backend/modules/prompt_generator/README.md` for any existing documentation or structure. Analyze the Reference Generator implementation (Module 5, which Ethan is currently working on) to understand what ReferenceImages data structure will be available as input, and review the Video Generator requirements (Module 7) to understand what format the output ClipPrompts must match.

**Next, create a detailed PRD following the structure and depth of `PRD_scene_planner.md`, ensuring it covers all implementation aspects.** The PRD must specify the exact inputs: `job_id: UUID`, `plan: ScenePlan` (from Scene Planner Module 4, containing clip_scripts with visual_description, motion, camera_angle, characters, scenes, beat_intensity, and style with color_palette, visual_style, mood, lighting, cinematography), and `reference: ReferenceImages` (from Reference Generator Module 5, containing scene_references and character_references with image_urls and metadata). The PRD must define the exact output: `ClipPrompts` model with a list of `ClipPrompt` objects, each containing `clip_index`, `prompt` (optimized string <200 words), `negative_prompt`, `duration` (from clip_scripts), `scene_reference_url` (mapped from ReferenceImages), `character_reference_urls` (list mapped from ReferenceImages), and `metadata` (word_count, style_keywords, scene_id, character_ids, validated flag). Include detailed file specifications for the module structure (similar to Scene Planner's directory layout), specifying files like `main.py`, `prompt_optimizer.py`, `style_synthesizer.py`, `reference_mapper.py`, `validator.py`, and comprehensive test files. Document the prompt synthesis algorithm that combines visual_description + motion + camera_angle + visual_style + color_palette + quality modifiers into a concise format, ensuring consistency of style keywords across all prompts, and handling edge cases like missing reference images (fallback to text-only prompts).

**Finally, ensure the PRD addresses integration, error handling, performance, and testing requirements consistent with the existing codebase patterns.** Specify how the module integrates with the orchestrator (40% progress milestone, called after Reference Generator completes), how it handles errors (retryable vs non-retryable, fallback strategies for missing references), cost tracking integration (using `shared.cost_tracking` if LLM calls are needed), and caching strategies if applicable. Define performance targets (<5s generation time for all prompts, batch generation in one pass), validation requirements (word count limits, style keyword consistency checks, reference URL validation), and comprehensive test coverage (unit tests for prompt synthesis logic, integration tests with mock ScenePlan and ReferenceImages, edge case testing for missing data). Include retry logic specifications (if using LLM for optimization, use `@retry_with_backoff` decorator), logging requirements (structured logging via `shared.logging`), and ensure the PRD aligns with the BUILD_ORDER.md dependencies (Module 6 depends on Modules 4 and 5, and Module 7 depends on Module 6's output). The PRD should be implementation-ready, providing enough detail for a developer to build the module without ambiguity, following the same level of specificity and thoroughness as the Scene Planner PRD.

